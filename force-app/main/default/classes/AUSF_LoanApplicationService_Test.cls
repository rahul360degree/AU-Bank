@isTest
public with sharing class AUSF_LoanApplicationService_Test {
    @testSetup
    static void setupTestData() { 
        List<Loan_Application__c> loanApps = new List<Loan_Application__c>();   
        loanApps = AUSF_TestDataFactory.createActiveLoanApplications(loanApps,1);
        loanApps = AUSF_TestDataFactory.createCancelledLoanApplications(loanApps,1);
        loanApps = AUSF_TestDataFactory.createRejectLoanApplications(loanApps,1);
        loanApps = AUSF_TestDataFactory.createDisbursedLoanApplications(loanApps,1);
        loanApps = AUSF_TestDataFactory.createActiveLeadLoanApplications(loanApps,2);
        insert loanApps;
        List<Lead_stage__c> leadStages = new List<Lead_Stage__c>();
        leadStages = AUSF_TestDataFactory.createLeadStagerecords(leadStages,1);
        insert leadStages;
        AUSF_TestDataFactory.createApplicantRecords(loanApps,loanApps.size());
        AUSF_TestDataFactory.createPLPAOffer(loanApps[0].Id,1);
        AUSF_TestDataFactory.createBLPAOffer(loanApps[0].Id,1);
        
    }
    @isTest
    static void testlocalDedupeSearch_ActiveApplication() {
        Test.startTest();
        Map<String,AUSF_LoanApplicationService.DedupeResult> result = AUSF_LoanApplicationService.localDedupeSearch(new List<String>{'1234567890'});
        Test.stopTest();
        System.assertEquals('Resume', result.get('1234567890').dedupeStatus);
        Assert.isNotNull(result.get('1234567890').existingLoanApplication);
        System.assertEquals('Pending', result.get('1234567890').existingLoanApplication.Stage__c);
    }
    @isTest
    static void testlocalDedupeSearch_CancelledApplication() {
        // Remove active application to test cancelled scenario
        delete [SELECT Id FROM Loan_Application__c WHERE Stage__c IN ('Pending','Reject','Disbursed','Operations')];
        Test.startTest();
        Map<String,AUSF_LoanApplicationService.DedupeResult> result = AUSF_LoanApplicationService.localDedupeSearch(new List<String>{'1234567890'});
        Test.stopTest();
        System.assertEquals('New', result.get('1234567890').dedupeStatus);
    }
    @isTest
    static void testlocalDedupeSearch_DisbursedApplication() {
        // Remove active application to test cancelled scenario
        delete [SELECT Id FROM Loan_Application__c WHERE Stage__c IN ('Pending')];
        Test.startTest();
        Map<String,AUSF_LoanApplicationService.DedupeResult> result = AUSF_LoanApplicationService.localDedupeSearch(new List<String>{'1234567890'});
        Test.stopTest();
        System.assertEquals('Disbursed', result.get('1234567890').dedupeStatus);
        Assert.isNotNull(result.get('1234567890').existingLoanApplication);
        System.assertEquals('1234567890', result.get('1234567890').existingLoanApplication.Mobile_Number__c);
    }
    @isTest
    static void testlocalDedupeSearch_RejectedApplication() {
        // Remove active and cancelled applications to test rejected scenario
        delete [SELECT Id FROM Loan_Application__c WHERE Stage__c IN ('Pending', 'Cancelled','Disbursed','Operations')];
        Test.startTest();
        Map<String,AUSF_LoanApplicationService.DedupeResult> result = AUSF_LoanApplicationService.localDedupeSearch(new List<String>{'1234567890'});
        Test.stopTest();
        System.assertEquals('Reject', result.get('1234567890').dedupeStatus);
        Assert.isNotNull(result.get('1234567890').existingLoanApplication);
        System.assertEquals('Reject', result.get('1234567890').existingLoanApplication.Stage__c);
    }
    @isTest
    static void testlocalDedupeSearch_NoExistingApplication() {
        Test.startTest();
        Map<String,AUSF_LoanApplicationService.DedupeResult> result = AUSF_LoanApplicationService.localDedupeSearch(new List<String>{'0987654321'});
        Test.stopTest();
        System.assertEquals('New', result.get('0987654321').dedupeStatus);
    }
    @isTest
    static void testPopulateLoanApplicationNumber() {
        // Create test data
        List<Loan_Application__c> loanApplications = [SELECT Id FROM Loan_Application__c Where Stage__c='Operations' Limit 2]; 
        List<Applicant__c> applicants = AUSF_TestDataFactory.createApplicantRecords(loanApplications,2);
        Applicant__c applicant = applicants[1];
        applicant.Employment_Type__c = 'Salaried - Private';
        update applicant;
        
        // Call the method
        Test.startTest();
        AUSF_LoanApplicationService.populateLoanApplicationNumber(new List<Id>{applicants[0].Id,applicants[1].Id});
        Test.stopTest();
        // Verify the results
        Loan_Application__c updatedLoanApp1 = [SELECT Name FROM Loan_Application__c WHERE Id = :loanApplications[0].Id];
        Loan_Application__c updatedLoanApp2 = [SELECT Name FROM Loan_Application__c WHERE Id = :loanApplications[1].Id];
        System.assert(updatedLoanApp1.Name!=null, 'Loan Application Number for Salaried applicant is incorrect');
        System.assert(updatedLoanApp2.Name!=null, 'Loan Application Number for Self-Employed applicant is incorrect');
    }
    
    @isTest
    static void testCreateNewLoanApplication() {
        // List of mobile numbers to pass to the method
        List<String> mobileNumbers = new List<String>{'1234567890'};
        // Call the method
        Test.startTest();
        AUSF_LoanApplicationService.RecordCreationResult loanApps = AUSF_LoanApplicationService.createNewLoanApplication(mobileNumbers);
        Test.stopTest();
        // Verify the results
        System.assert(loanApps !=null, 'One loan applications should be created.');
    }
    @isTest
    static void testValidatePAOfferProductType() {
        // Create test Loan_Application__c record
        Loan_Application__c loanApp = [SELECT Id FROM Loan_Application__c Where Stage__c='Pending' Limit 2];
        
        // Create test Pre_Approved_Offer__c records with Product_Type__c = 'PL'
        Pre_Approved_Offer__c offerPL = [SELECT Id,OfferIsActive__c,Product_Type__c FROM Pre_Approved_Offer__c Where Loan_Application__c=:loanApp.Id and Product_Type__c='PL' ];

        // Create test Pre_Approved_Offer__c records with Product_Type__c = 'BL'
        Pre_Approved_Offer__c offerBL = [SELECT Id,OfferIsActive__c,Product_Type__c FROM Pre_Approved_Offer__c Where Loan_Application__c=:loanApp.Id and Product_Type__c='BL' ];
        
        // Test case 1: Validate with PL offer
        Boolean result = AUSF_LoanApplicationService.validatePAOfferProductType(loanApp.Id);
        System.assertEquals(true, result, 'The method should return true for PL offer');

        // Deactivate PL offer and test with BL offer
        offerPL.OfferIsActive__c = false;
        update offerPL;

        result = AUSF_LoanApplicationService.validatePAOfferProductType(loanApp.Id);
        System.assertEquals(false, result, 'The method should return false for BL offer');
        
        // Deactivate BL offer and test with no active offer
        offerBL.OfferIsActive__c = false;
        update offerBL;

        result = AUSF_LoanApplicationService.validatePAOfferProductType(loanApp.Id);
        System.assertEquals(false, result, 'The method should return false if no active offer is found');
    }
    @isTest
    static void testAditionalDedupeCheckForSefEmpNonPaOffr() {
        // Create test data for Loan_Application__c
        Applicant__c applicant = [SELECT Id,Loan_Application__c,Mobile_Number__c,PAN__c,Loan_Application__r.Employment_Type_Formula__c,Loan_Application__r.Has_PA_Offer__c FROM Applicant__c WHERE Loan_Application__r.Stage__c='Pending'];
        Loan_Application__c loanApp = new Loan_Application__c(
            Id = applicant.Loan_Application__c,
            Employment_Type_Formula__c = 'Self Employed',
            Has_PA_Offer__c = false
        );
        update loanApp;

        // Create test data for Applicant__c
        applicant.Mobile_Number__c ='1234567890';
        applicant.PAN__c = 'ABCDE1234F';
        update applicant;

        Integration_Master__c intMaster = AUSF_TestDataFactory.createIntegrationMaster('Customer Dedupe Detail','','','','','');
        insert intMaster;
        // Create test data for Integration_Checklist__c
        Integration_Checklist__c integrationChecklist = new Integration_Checklist__c(
            Integration_Master__c = intMaster.Id,
            Loan_Application__c = loanApp.Id,
            Applicant__c = applicant.Id,
            Status__c = 'Completed',  // AUSF_IC_COMPLETED
            Response__c = '{"TransactionStatus":{"ResponseCode":"0","ResponseMessage":"Success","ExtendedErrorDetails":{"messages":{"code":"0","message":null}},"ValidationErrors":{"ApplicableAttributes":null,"AttributeName":null,"AttributeValue":null,"ErrorCode":null,"ErrorMessage":null}},"MatchFound":[{"CustomerResponse":{"CustomerMemo":null,"CustomerBasicInquiry":{"CustomerId":"2131455278","NationalIdentificationCode":"2131455278","CustomerName":{"Prefix":"MR.","FirstName":"IFRAN","MidName":null,"LastName":"KHAN","ShortName":"IFRAN Khan","SingleFullName":null,"FormattedFullName":"IFRAN##KHAN","FullName":"IFRAN KHAN"},"CustomerFullName":"IFRAN KHAN","OfficerID":null,"CustomerAddress":{"Line1":"5th floor","Line2":"Kanakia Zillon","Line3":"BKC Kurla West","Line4":null,"City":"MUMBAI","State":"MAHARASHTRA","Country":"India","Zip":"400070"},"BirthDateText":"1984-06-07","CategoryType":"INDIVIDUAL - FULL KYC","Sex":"M","IsImageAvailable":"false","IsSignatureAvailable":"true","CombWithdrawBal":null,"AgeOfCustRel":"2017-09-28","AadhaarDetail":{"AadhaarNumber":"21314552","AadhaarLinkAccount":null},"HomeBranch":"2276","MobileNumber":"1234567890","EmailAddress":"21314552@axc.com","IcType":null,"IcTypeDesc":null,"BankShortName":"Jalore_Bagoda Road","PAN":"ABCDE1234F","CustomerType":"100","AadharUpdateDate":null}},"CRMQueryResults":[{"BankName":null,"Scheme":null,"Avail":"No","off_ex1_8":null,"ProductId":11704,"OfferType":null,"OfferId":"726882","RatingID":1,"ValidFrom":"2023-06-26T00:00:00+05:30","OfferDescription":"Savings Account - AU Royale","Royale":null,"MinLoanTenureinMonths":"6","CustomerNameinBankAccount":null,"CustomerId":"22143391","OfferIsActive":"true","RepaymentMode":null,"Mobile":"9988774410","CurrencyID":null,"MaxLoanTenureinMonths":"48","OfferName":"Savings Account - AU Royale","Occupation":null,"IFSCcode":null,"RowNumber":1,"FirstOfferAmount":300000,"Employee":null,"BankBranch":null,"ValidTill":"2025-06-27T23:59:00+05:30","Image_Offers":"plbanner","TermsAndCondition":null,"RateofInterest":"16.000000","Location":null,"TerritoryCode":"2011","loginid":null,"OfferSource":"Website Download","remarks":"PL","Comments":"1.25","BankAccountNumber":"2342346238","CIBILScore":"195"}],"CreditCardResponse":[{"CustomerID":"2233XXXX","CustomerAccountRelation":"Sole Owner","AccountNumber":"0001691XXXXXXXXXXXX","LoanStatus":"PA","CustomerFullName":"AKASH G","ProductCode":"101","Decode":"ALTURA","AccountOpenDate":"2021-01-20 00:00:00","AccountStatus":"ACCOUNT OPEN REGULAR","SanctionedAmount":"50000","DPDValue":"0","LastStatementBalance":"8,692.67"}],"NPADPD":[{"GrossAdvance":66469,"Last30DaysUpg":"","ACID":"","Filler_3":"","UCIF":"25200586","Date":"27-04-2024","NPAStatus":"Y","Filler_2":"","Filler_1":"","NPADate":null,"CustID":"","IsTWO":"N","DPD":0,"AssetClass":"STANDARD","OriginalProduct":"","TotalProvision":265.88},{"GrossAdvance":66469,"Last30DaysUpg":"","ACID":"9001010635460038","Filler_3":"","UCIF":"25200586","Date":"27-04-2024","NPAStatus":"Y","Filler_2":"","Filler_1":"","NPADate":null,"CustID":"25200586","IsTWO":"N","DPD":0,"AssetClass":"STANDARD","OriginalProduct":"A_WHEELS","TotalProvision":265.88}],"AccountDetails":{"CustomerAccount":[{"ModuleCode":"C","ProductName":"20101-AU Savings Account - Value","AccountId":"1711227610089667","CASAAccountName":null,"CurrencyCode":"1","CurrencyShortName":"INR","CustomerRelationship":"SOW","BalanceBook":"99.00","UnclearFunds":"0.00","Classification":"NORMAL","Reason":"UNBLOCKED ","BillAmount":"0.00","OriginalBalance":"0.00","CurrentStatus":"8","CurrentStatusDescription":"ACCOUNT OPEN REGULAR","AcyAmount":"699.00","AvailableBalance":"699.00","LcyAmount":"699.00","TotalAcyAmount":"699.00","TotalLcyAmount":"699.00","BranchName":"Jalore_Bagoda Road","ExternalAccountId":"0","LoanApplicationNumber":null,"FutureDatedAmount":"0.00","SafeDepositBoxId":"0","Iban":"0","DateAccountOpen":"2017-09-28","DateAccountActive":null,"DateRelation":"2017-09-28","MonthsSinceActive":"47","BalUncollectedPrinc":"0.00","BalUncollectedInt":"0.00","TotalBalUncollecPrinc":"0.00","TotalBalUncollecInt":"0.00","TotalBalBook":"99.00","DateValue":"2017-05-04","BalPrincipal":"0","IntRate":"0","DepositNo":null,"MaturityDate":null,"LienAmount":"0","InstallmentAmount":"0","OtherArrear":"0","DepositStatus":null,"BalCombinedAcy":"699.0","BalCombinedLcy":"699.0","BranchCode":"2276","IsMaturity":null,"IsTDLinkage":"N ","MaturityAmount":null,"DepStat":null,"DisbursedAmount":null,"DraweeAccountNo":null,"EmailId":null,"EmiTenure":null,"HoldAmount":"0","LoanAccountName":null,"MobileNumber":null,"NomineeName":"PRAVEENA BANU","ODLimitSactioned":"0","ODLimitUtilized":"0","OperationMode":"SINGLYnull","SmallClearingAccountNo":"000207","TDAccountName":null,"CASARelationshipDetails":{"CustomerId":"21314552","Emailid":"21314552@axc.com","JointHolderName":"IFRAN KHAN","MobileNo":"8104655801","Relationship":"SOW"},"AmtGoal":"0","AmtGoalNew":null,"CodAcctCcy":null,"CodAcctNo":null,"CodGoalAcctStat":null,"CodGoalAcctXfer":null,"CodGoalAcctXferTitle":null,"CodGoalName":null,"CodGoalRefNo":null,"CtrGoalTermDays":null,"CtrGoalTermDaysNew":null,"CtrGoalTermMon":null,"CtrGoalTermMonNew":null,"CtrGoalTermYear":null,"CtrGoalTermYearNew":null,"DatMaturityNew":null,"ProductCode":"20101","RatGoalInt":null,"Tenure":"0 Months 0 Days 0 Years "},{"ModuleCode":"L","ProductName":"10103-Securitization and Assignment","AccountId":"9001020101389851","CASAAccountName":null,"CurrencyCode":"1","CurrencyShortName":"INR","CustomerRelationship":"SOW","BalanceBook":"0.00","UnclearFunds":"0.00","Classification":"NORMAL","Reason":" ","BillAmount":"0.00","OriginalBalance":"390000.00","CurrentStatus":"8","CurrentStatusDescription":"ACCOUNT CLOSED","AcyAmount":"0.00","AvailableBalance":"0.00","LcyAmount":"0.00","TotalAcyAmount":"0.00","TotalLcyAmount":"0.00","BranchName":"Jalore_Bagoda Road","ExternalAccountId":null,"LoanApplicationNumber":"9001020101389851 ","FutureDatedAmount":"0.00","SafeDepositBoxId":"0","Iban":null,"DateAccountOpen":"2014-12-25","DateAccountActive":null,"DateRelation":null,"MonthsSinceActive":"0","BalUncollectedPrinc":"0.00","BalUncollectedInt":"0.00","TotalBalUncollecPrinc":"0.00","TotalBalUncollecInt":"0.00","TotalBalBook":"0.00","DateValue":null,"BalPrincipal":"0","IntRate":"0","DepositNo":null,"MaturityDate":"2017-11-23","LienAmount":"0","InstallmentAmount":"0","OtherArrear":"0","DepositStatus":null,"BalCombinedAcy":"0.0","BalCombinedLcy":"0.0","BranchCode":"2276","IsMaturity":null,"IsTDLinkage":"N ","MaturityAmount":null,"DepStat":null,"DisbursedAmount":"390000","DraweeAccountNo":null,"EmailId":null,"EmiTenure":"35","HoldAmount":null,"LoanAccountName":"IFRAN Khan","MobileNumber":null,"NomineeName":null,"ODLimitSactioned":null,"ODLimitUtilized":null,"OperationMode":null,"SmallClearingAccountNo":null,"TDAccountName":null,"AmtGoal":"0","AmtGoalNew":null,"CodAcctCcy":null,"CodAcctNo":null,"CodGoalAcctStat":null,"CodGoalAcctXfer":null,"CodGoalAcctXferTitle":null,"CodGoalName":null,"CodGoalRefNo":null,"CtrGoalTermDays":null,"CtrGoalTermDaysNew":null,"CtrGoalTermMon":null,"CtrGoalTermMonNew":null,"CtrGoalTermYear":null,"CtrGoalTermYearNew":null,"DatMaturityNew":null,"ProductCode":"10103","RatGoalInt":null,"Tenure":"35 Months 0 Days 0 Years "}]}},{"CustomerResponse":{"CustomerMemo":null,"CustomerBasicInquiry":{"CustomerId":"21314552","NationalIdentificationCode":"21314552","CustomerName":{"Prefix":"MR.","FirstName":"IFRAN","MidName":null,"LastName":"KHAN","ShortName":"IFRAN Khan","SingleFullName":null,"FormattedFullName":"IFRAN##KHAN","FullName":"IFRAN KHAN"},"CustomerFullName":"IFRAN KHAN","OfficerID":null,"CustomerAddress":{"Line1":"5th floor","Line2":"Kanakia Zillon","Line3":"BKC Kurla West","Line4":null,"City":"MUMBAI","State":"MAHARASHTRA","Country":"India","Zip":"400070"},"BirthDateText":"1984-06-07","CategoryType":"INDIVIDUAL - FULL KYC","Sex":"M","IsImageAvailable":"false","IsSignatureAvailable":"true","CombWithdrawBal":null,"AgeOfCustRel":"2017-09-28","AadhaarDetail":{"AadhaarNumber":"21314552","AadhaarLinkAccount":null},"HomeBranch":"2276","MobileNumber":"8104655801","EmailAddress":"21314552@axc.com","IcType":null,"IcTypeDesc":null,"BankShortName":"Jalore_Bagoda Road","PAN":"ABCDE3333R","CustomerType":"100","AadharUpdateDate":null}},"CRMQueryResults":[{"BankName":null,"Scheme":null,"Avail":"No","off_ex1_8":null,"ProductId":11704,"OfferType":null,"OfferId":"726882","RatingID":1,"ValidFrom":"2023-06-26T00:00:00+05:30","OfferDescription":"Savings Account - AU Royale","Royale":null,"MinLoanTenureinMonths":"6","CustomerNameinBankAccount":null,"CustomerId":"22143391","OfferIsActive":"true","RepaymentMode":null,"Mobile":"9988774410","CurrencyID":null,"MaxLoanTenureinMonths":"48","OfferName":"Savings Account - AU Royale","Occupation":null,"IFSCcode":null,"RowNumber":1,"FirstOfferAmount":300000,"Employee":null,"BankBranch":null,"ValidTill":"2025-06-27T23:59:00+05:30","Image_Offers":"plbanner","TermsAndCondition":null,"RateofInterest":"16.000000","Location":null,"TerritoryCode":"2011","loginid":null,"OfferSource":"Website Download","remarks":"PL","Comments":"1.25","BankAccountNumber":"23423462387","CIBILScore":"195"}],"CreditCardResponse":[{"CustomerID":"2233XXXX","CustomerAccountRelation":"Sole Owner","AccountNumber":"0001691XXXXXXXXXXXX","LoanStatus":"PA","CustomerFullName":"AKASH G","ProductCode":"101","Decode":"ALTURA","AccountOpenDate":"2021-01-20 00:00:00","AccountStatus":"ACCOUNT OPEN REGULAR","SanctionedAmount":"50000","DPDValue":"0","LastStatementBalance":"8,692.67"}],"NPADPD":[{"GrossAdvance":66469,"Last30DaysUpg":"","ACID":"","Filler_3":"","UCIF":"25200586","Date":"27-04-2024","NPAStatus":"N","Filler_2":"","Filler_1":"","NPADate":null,"CustID":"","IsTWO":"N","DPD":0,"AssetClass":"STANDARD","OriginalProduct":"","TotalProvision":265.88},{"GrossAdvance":66469,"Last30DaysUpg":"","ACID":"9001010635460038","Filler_3":"","UCIF":"25200586","Date":"27-04-2024","NPAStatus":"N","Filler_2":"","Filler_1":"","NPADate":null,"CustID":"25200586","IsTWO":"N","DPD":0,"AssetClass":"STANDARD","OriginalProduct":"A_WHEELS","TotalProvision":265.88}],"AccountDetails":{"CustomerAccount":[{"ModuleCode":"C","ProductName":"20101-AU Savings Account - Value","AccountId":"1711227610089667","CASAAccountName":null,"CurrencyCode":"1","CurrencyShortName":"INR","CustomerRelationship":"SOW","BalanceBook":"99.00","UnclearFunds":"0.00","Classification":"NORMAL","Reason":"UNBLOCKED ","BillAmount":"0.00","OriginalBalance":"0.00","CurrentStatus":"8","CurrentStatusDescription":"ACCOUNT OPEN REGULAR","AcyAmount":"699.00","AvailableBalance":"699.00","LcyAmount":"699.00","TotalAcyAmount":"699.00","TotalLcyAmount":"699.00","BranchName":"Jalore_Bagoda Road","ExternalAccountId":"0","LoanApplicationNumber":null,"FutureDatedAmount":"0.00","SafeDepositBoxId":"0","Iban":"0","DateAccountOpen":"2017-09-28","DateAccountActive":null,"DateRelation":"2017-09-28","MonthsSinceActive":"47","BalUncollectedPrinc":"0.00","BalUncollectedInt":"0.00","TotalBalUncollecPrinc":"0.00","TotalBalUncollecInt":"0.00","TotalBalBook":"99.00","DateValue":"2017-05-04","BalPrincipal":"0","IntRate":"0","DepositNo":null,"MaturityDate":null,"LienAmount":"0","InstallmentAmount":"0","OtherArrear":"0","DepositStatus":null,"BalCombinedAcy":"699.0","BalCombinedLcy":"699.0","BranchCode":"2276","IsMaturity":null,"IsTDLinkage":"N ","MaturityAmount":null,"DepStat":null,"DisbursedAmount":null,"DraweeAccountNo":null,"EmailId":null,"EmiTenure":null,"HoldAmount":"0","LoanAccountName":null,"MobileNumber":null,"NomineeName":"PRAVEENA BANU","ODLimitSactioned":"0","ODLimitUtilized":"0","OperationMode":"SINGLYnull","SmallClearingAccountNo":"000207","TDAccountName":null,"CASARelationshipDetails":{"CustomerId":"21314552","Emailid":"21314552@axc.com","JointHolderName":"IFRAN KHAN","MobileNo":"8104655801","Relationship":"SOW"},"AmtGoal":"0","AmtGoalNew":null,"CodAcctCcy":null,"CodAcctNo":null,"CodGoalAcctStat":null,"CodGoalAcctXfer":null,"CodGoalAcctXferTitle":null,"CodGoalName":null,"CodGoalRefNo":null,"CtrGoalTermDays":null,"CtrGoalTermDaysNew":null,"CtrGoalTermMon":null,"CtrGoalTermMonNew":null,"CtrGoalTermYear":null,"CtrGoalTermYearNew":null,"DatMaturityNew":null,"ProductCode":"20101","RatGoalInt":null,"Tenure":"0 Months 0 Days 0 Years "},{"ModuleCode":"L","ProductName":"10103-Securitization and Assignment","AccountId":"9001020101389851","CASAAccountName":null,"CurrencyCode":"1","CurrencyShortName":"INR","CustomerRelationship":"SOW","BalanceBook":"0.00","UnclearFunds":"0.00","Classification":"NORMAL","Reason":" ","BillAmount":"0.00","OriginalBalance":"390000.00","CurrentStatus":"1","CurrentStatusDescription":"ACCOUNT CLOSED","AcyAmount":"0.00","AvailableBalance":"0.00","LcyAmount":"0.00","TotalAcyAmount":"0.00","TotalLcyAmount":"0.00","BranchName":"Jalore_Bagoda Road","ExternalAccountId":null,"LoanApplicationNumber":"9001020101389851 ","FutureDatedAmount":"0.00","SafeDepositBoxId":"0","Iban":null,"DateAccountOpen":"2014-12-25","DateAccountActive":null,"DateRelation":null,"MonthsSinceActive":"0","BalUncollectedPrinc":"0.00","BalUncollectedInt":"0.00","TotalBalUncollecPrinc":"0.00","TotalBalUncollecInt":"0.00","TotalBalBook":"0.00","DateValue":null,"BalPrincipal":"0","IntRate":"0","DepositNo":null,"MaturityDate":"2017-11-23","LienAmount":"0","InstallmentAmount":"0","OtherArrear":"0","DepositStatus":null,"BalCombinedAcy":"0.0","BalCombinedLcy":"0.0","BranchCode":"2276","IsMaturity":null,"IsTDLinkage":"N ","MaturityAmount":null,"DepStat":null,"DisbursedAmount":"390000","DraweeAccountNo":null,"EmailId":null,"EmiTenure":"35","HoldAmount":null,"LoanAccountName":"IFRAN Khan","MobileNumber":null,"NomineeName":null,"ODLimitSactioned":null,"ODLimitUtilized":null,"OperationMode":null,"SmallClearingAccountNo":null,"TDAccountName":null,"AmtGoal":"0","AmtGoalNew":null,"CodAcctCcy":null,"CodAcctNo":null,"CodGoalAcctStat":null,"CodGoalAcctXfer":null,"CodGoalAcctXferTitle":null,"CodGoalName":null,"CodGoalRefNo":null,"CtrGoalTermDays":null,"CtrGoalTermDaysNew":null,"CtrGoalTermMon":null,"CtrGoalTermMonNew":null,"CtrGoalTermYear":null,"CtrGoalTermYearNew":null,"DatMaturityNew":null,"ProductCode":"10103","RatGoalInt":null,"Tenure":"35 Months 0 Days 0 Years "}]}}]}' // Mock JSON response
        );
        insert integrationChecklist;
        // Call the method under test
        Test.startTest();
        Boolean isLoanRejected = AUSF_LoanApplicationService.aditionalDedupeCheck(applicant.Id);
        Test.stopTest();

        // Verify the results
        loanApp = [SELECT Stage__c, Reject_Reason__c FROM Loan_Application__c WHERE Id = :loanApp.Id];
        System.assertEquals(true, isLoanRejected);
        System.assertEquals('Reject', loanApp.Stage__c);
        System.assertEquals('Dedupe check', loanApp.Reject_Reason__c);  // Update with actual reason code
    }

    @isTest
    static void testAditionalDedupeCheckForSefEmpPaOffr() {
        // Create test data for Loan_Application__c
        Applicant__c applicant = [SELECT Id,Loan_Application__c,Mobile_Number__c,PAN__c,Loan_Application__r.Employment_Type_Formula__c,Loan_Application__r.Has_PA_Offer__c FROM Applicant__c WHERE Loan_Application__r.Stage__c='Pending'];
        Loan_Application__c loanApp = new Loan_Application__c(
            Id = applicant.Loan_Application__c,
            Employment_Type_Formula__c = 'Self Employed',
            Has_PA_Offer__c = true
        );
        update loanApp;

        // Create test data for Applicant__c
        applicant.Mobile_Number__c ='1234567890';
        applicant.PAN__c = 'ABCDE1234F';
        update applicant;

        Integration_Master__c intMaster = AUSF_TestDataFactory.createIntegrationMaster('Customer Dedupe Detail','','','','','');
        insert intMaster;
        // Create test data for Integration_Checklist__c
        Integration_Checklist__c integrationChecklist = new Integration_Checklist__c(
            Integration_Master__c = intMaster.Id,
            Loan_Application__c = loanApp.Id,
            Applicant__c = applicant.Id,
            Status__c = 'Completed',  // AUSF_IC_COMPLETED
            Response__c = '{"TransactionStatus":{"ResponseCode":"0","ResponseMessage":"Success","ExtendedErrorDetails":{"messages":{"code":"0","message":null}},"ValidationErrors":{"ApplicableAttributes":null,"AttributeName":null,"AttributeValue":null,"ErrorCode":null,"ErrorMessage":null}},"MatchFound":[{"CustomerResponse":{"CustomerMemo":null,"CustomerBasicInquiry":{"CustomerId":"2131455278","NationalIdentificationCode":"2131455278","CustomerName":{"Prefix":"MR.","FirstName":"IFRAN","MidName":null,"LastName":"KHAN","ShortName":"IFRAN Khan","SingleFullName":null,"FormattedFullName":"IFRAN##KHAN","FullName":"IFRAN KHAN"},"CustomerFullName":"IFRAN KHAN","OfficerID":null,"CustomerAddress":{"Line1":"5th floor","Line2":"Kanakia Zillon","Line3":"BKC Kurla West","Line4":null,"City":"MUMBAI","State":"MAHARASHTRA","Country":"India","Zip":"400070"},"BirthDateText":"1984-06-07","CategoryType":"INDIVIDUAL - FULL KYC","Sex":"M","IsImageAvailable":"false","IsSignatureAvailable":"true","CombWithdrawBal":null,"AgeOfCustRel":"2017-09-28","AadhaarDetail":{"AadhaarNumber":"21314552","AadhaarLinkAccount":null},"HomeBranch":"2276","MobileNumber":"1234567890","EmailAddress":"21314552@axc.com","IcType":null,"IcTypeDesc":null,"BankShortName":"Jalore_Bagoda Road","PAN":"ABCDE1234F","CustomerType":"100","AadharUpdateDate":null}},"CRMQueryResults":[{"BankName":null,"Scheme":null,"Avail":"No","off_ex1_8":null,"ProductId":11704,"OfferType":null,"OfferId":"726882","RatingID":1,"ValidFrom":"2023-06-26T00:00:00+05:30","OfferDescription":"Savings Account - AU Royale","Royale":null,"MinLoanTenureinMonths":"6","CustomerNameinBankAccount":null,"CustomerId":"22143391","OfferIsActive":"true","RepaymentMode":null,"Mobile":"9988774410","CurrencyID":null,"MaxLoanTenureinMonths":"48","OfferName":"Savings Account - AU Royale","Occupation":null,"IFSCcode":null,"RowNumber":1,"FirstOfferAmount":300000,"Employee":null,"BankBranch":null,"ValidTill":"2025-06-27T23:59:00+05:30","Image_Offers":"plbanner","TermsAndCondition":null,"RateofInterest":"16.000000","Location":null,"TerritoryCode":"2011","loginid":null,"OfferSource":"Website Download","remarks":"PL","Comments":"1.25","BankAccountNumber":"2342346238","CIBILScore":"195"}],"CreditCardResponse":[{"CustomerID":"2233XXXX","CustomerAccountRelation":"Sole Owner","AccountNumber":"0001691XXXXXXXXXXXX","LoanStatus":"PA","CustomerFullName":"AKASH G","ProductCode":"101","Decode":"ALTURA","AccountOpenDate":"2021-01-20 00:00:00","AccountStatus":"ACCOUNT OPEN REGULAR","SanctionedAmount":"50000","DPDValue":"0","LastStatementBalance":"8,692.67"}],"NPADPD":[{"GrossAdvance":66469,"Last30DaysUpg":"","ACID":"","Filler_3":"","UCIF":"25200586","Date":"27-04-2024","NPAStatus":"Y","Filler_2":"","Filler_1":"","NPADate":null,"CustID":"","IsTWO":"N","DPD":0,"AssetClass":"STANDARD","OriginalProduct":"","TotalProvision":265.88},{"GrossAdvance":66469,"Last30DaysUpg":"","ACID":"9001010635460038","Filler_3":"","UCIF":"25200586","Date":"27-04-2024","NPAStatus":"Y","Filler_2":"","Filler_1":"","NPADate":null,"CustID":"25200586","IsTWO":"N","DPD":0,"AssetClass":"STANDARD","OriginalProduct":"A_WHEELS","TotalProvision":265.88}],"AccountDetails":{"CustomerAccount":[{"ModuleCode":"C","ProductName":"20101-AU Savings Account - Value","AccountId":"1711227610089667","CASAAccountName":null,"CurrencyCode":"1","CurrencyShortName":"INR","CustomerRelationship":"SOW","BalanceBook":"99.00","UnclearFunds":"0.00","Classification":"NORMAL","Reason":"UNBLOCKED ","BillAmount":"0.00","OriginalBalance":"0.00","CurrentStatus":"8","CurrentStatusDescription":"ACCOUNT OPEN REGULAR","AcyAmount":"699.00","AvailableBalance":"699.00","LcyAmount":"699.00","TotalAcyAmount":"699.00","TotalLcyAmount":"699.00","BranchName":"Jalore_Bagoda Road","ExternalAccountId":"0","LoanApplicationNumber":null,"FutureDatedAmount":"0.00","SafeDepositBoxId":"0","Iban":"0","DateAccountOpen":"2017-09-28","DateAccountActive":null,"DateRelation":"2017-09-28","MonthsSinceActive":"47","BalUncollectedPrinc":"0.00","BalUncollectedInt":"0.00","TotalBalUncollecPrinc":"0.00","TotalBalUncollecInt":"0.00","TotalBalBook":"99.00","DateValue":"2017-05-04","BalPrincipal":"0","IntRate":"0","DepositNo":null,"MaturityDate":null,"LienAmount":"0","InstallmentAmount":"0","OtherArrear":"0","DepositStatus":null,"BalCombinedAcy":"699.0","BalCombinedLcy":"699.0","BranchCode":"2276","IsMaturity":null,"IsTDLinkage":"N ","MaturityAmount":null,"DepStat":null,"DisbursedAmount":null,"DraweeAccountNo":null,"EmailId":null,"EmiTenure":null,"HoldAmount":"0","LoanAccountName":null,"MobileNumber":null,"NomineeName":"PRAVEENA BANU","ODLimitSactioned":"0","ODLimitUtilized":"0","OperationMode":"SINGLYnull","SmallClearingAccountNo":"000207","TDAccountName":null,"CASARelationshipDetails":{"CustomerId":"21314552","Emailid":"21314552@axc.com","JointHolderName":"IFRAN KHAN","MobileNo":"8104655801","Relationship":"SOW"},"AmtGoal":"0","AmtGoalNew":null,"CodAcctCcy":null,"CodAcctNo":null,"CodGoalAcctStat":null,"CodGoalAcctXfer":null,"CodGoalAcctXferTitle":null,"CodGoalName":null,"CodGoalRefNo":null,"CtrGoalTermDays":null,"CtrGoalTermDaysNew":null,"CtrGoalTermMon":null,"CtrGoalTermMonNew":null,"CtrGoalTermYear":null,"CtrGoalTermYearNew":null,"DatMaturityNew":null,"ProductCode":"20101","RatGoalInt":null,"Tenure":"0 Months 0 Days 0 Years "},{"ModuleCode":"L","ProductName":"10103-Securitization and Assignment","AccountId":"9001020101389851","CASAAccountName":null,"CurrencyCode":"1","CurrencyShortName":"INR","CustomerRelationship":"SOW","BalanceBook":"0.00","UnclearFunds":"0.00","Classification":"NORMAL","Reason":" ","BillAmount":"0.00","OriginalBalance":"390000.00","CurrentStatus":"8","CurrentStatusDescription":"ACCOUNT CLOSED","AcyAmount":"0.00","AvailableBalance":"0.00","LcyAmount":"0.00","TotalAcyAmount":"0.00","TotalLcyAmount":"0.00","BranchName":"Jalore_Bagoda Road","ExternalAccountId":null,"LoanApplicationNumber":"9001020101389851 ","FutureDatedAmount":"0.00","SafeDepositBoxId":"0","Iban":null,"DateAccountOpen":"2014-12-25","DateAccountActive":null,"DateRelation":null,"MonthsSinceActive":"0","BalUncollectedPrinc":"0.00","BalUncollectedInt":"0.00","TotalBalUncollecPrinc":"0.00","TotalBalUncollecInt":"0.00","TotalBalBook":"0.00","DateValue":null,"BalPrincipal":"0","IntRate":"0","DepositNo":null,"MaturityDate":"2017-11-23","LienAmount":"0","InstallmentAmount":"0","OtherArrear":"0","DepositStatus":null,"BalCombinedAcy":"0.0","BalCombinedLcy":"0.0","BranchCode":"2276","IsMaturity":null,"IsTDLinkage":"N ","MaturityAmount":null,"DepStat":null,"DisbursedAmount":"390000","DraweeAccountNo":null,"EmailId":null,"EmiTenure":"35","HoldAmount":null,"LoanAccountName":"IFRAN Khan","MobileNumber":null,"NomineeName":null,"ODLimitSactioned":null,"ODLimitUtilized":null,"OperationMode":null,"SmallClearingAccountNo":null,"TDAccountName":null,"AmtGoal":"0","AmtGoalNew":null,"CodAcctCcy":null,"CodAcctNo":null,"CodGoalAcctStat":null,"CodGoalAcctXfer":null,"CodGoalAcctXferTitle":null,"CodGoalName":null,"CodGoalRefNo":null,"CtrGoalTermDays":null,"CtrGoalTermDaysNew":null,"CtrGoalTermMon":null,"CtrGoalTermMonNew":null,"CtrGoalTermYear":null,"CtrGoalTermYearNew":null,"DatMaturityNew":null,"ProductCode":"10103","RatGoalInt":null,"Tenure":"35 Months 0 Days 0 Years "}]}},{"CustomerResponse":{"CustomerMemo":null,"CustomerBasicInquiry":{"CustomerId":"21314552","NationalIdentificationCode":"21314552","CustomerName":{"Prefix":"MR.","FirstName":"IFRAN","MidName":null,"LastName":"KHAN","ShortName":"IFRAN Khan","SingleFullName":null,"FormattedFullName":"IFRAN##KHAN","FullName":"IFRAN KHAN"},"CustomerFullName":"IFRAN KHAN","OfficerID":null,"CustomerAddress":{"Line1":"5th floor","Line2":"Kanakia Zillon","Line3":"BKC Kurla West","Line4":null,"City":"MUMBAI","State":"MAHARASHTRA","Country":"India","Zip":"400070"},"BirthDateText":"1984-06-07","CategoryType":"INDIVIDUAL - FULL KYC","Sex":"M","IsImageAvailable":"false","IsSignatureAvailable":"true","CombWithdrawBal":null,"AgeOfCustRel":"2017-09-28","AadhaarDetail":{"AadhaarNumber":"21314552","AadhaarLinkAccount":null},"HomeBranch":"2276","MobileNumber":"8104655801","EmailAddress":"21314552@axc.com","IcType":null,"IcTypeDesc":null,"BankShortName":"Jalore_Bagoda Road","PAN":"ABCDE3333R","CustomerType":"100","AadharUpdateDate":null}},"CRMQueryResults":[{"BankName":null,"Scheme":null,"Avail":"No","off_ex1_8":null,"ProductId":11704,"OfferType":null,"OfferId":"726882","RatingID":1,"ValidFrom":"2023-06-26T00:00:00+05:30","OfferDescription":"Savings Account - AU Royale","Royale":null,"MinLoanTenureinMonths":"6","CustomerNameinBankAccount":null,"CustomerId":"22143391","OfferIsActive":"true","RepaymentMode":null,"Mobile":"9988774410","CurrencyID":null,"MaxLoanTenureinMonths":"48","OfferName":"Savings Account - AU Royale","Occupation":null,"IFSCcode":null,"RowNumber":1,"FirstOfferAmount":300000,"Employee":null,"BankBranch":null,"ValidTill":"2025-06-27T23:59:00+05:30","Image_Offers":"plbanner","TermsAndCondition":null,"RateofInterest":"16.000000","Location":null,"TerritoryCode":"2011","loginid":null,"OfferSource":"Website Download","remarks":"PL","Comments":"1.25","BankAccountNumber":"23423462387","CIBILScore":"195"}],"CreditCardResponse":[{"CustomerID":"2233XXXX","CustomerAccountRelation":"Sole Owner","AccountNumber":"0001691XXXXXXXXXXXX","LoanStatus":"PA","CustomerFullName":"AKASH G","ProductCode":"101","Decode":"ALTURA","AccountOpenDate":"2021-01-20 00:00:00","AccountStatus":"ACCOUNT OPEN REGULAR","SanctionedAmount":"50000","DPDValue":"0","LastStatementBalance":"8,692.67"}],"NPADPD":[{"GrossAdvance":66469,"Last30DaysUpg":"","ACID":"","Filler_3":"","UCIF":"25200586","Date":"27-04-2024","NPAStatus":"N","Filler_2":"","Filler_1":"","NPADate":null,"CustID":"","IsTWO":"N","DPD":0,"AssetClass":"STANDARD","OriginalProduct":"","TotalProvision":265.88},{"GrossAdvance":66469,"Last30DaysUpg":"","ACID":"9001010635460038","Filler_3":"","UCIF":"25200586","Date":"27-04-2024","NPAStatus":"N","Filler_2":"","Filler_1":"","NPADate":null,"CustID":"25200586","IsTWO":"N","DPD":0,"AssetClass":"STANDARD","OriginalProduct":"A_WHEELS","TotalProvision":265.88}],"AccountDetails":{"CustomerAccount":[{"ModuleCode":"C","ProductName":"20101-AU Savings Account - Value","AccountId":"1711227610089667","CASAAccountName":null,"CurrencyCode":"1","CurrencyShortName":"INR","CustomerRelationship":"SOW","BalanceBook":"99.00","UnclearFunds":"0.00","Classification":"NORMAL","Reason":"UNBLOCKED ","BillAmount":"0.00","OriginalBalance":"0.00","CurrentStatus":"8","CurrentStatusDescription":"ACCOUNT OPEN REGULAR","AcyAmount":"699.00","AvailableBalance":"699.00","LcyAmount":"699.00","TotalAcyAmount":"699.00","TotalLcyAmount":"699.00","BranchName":"Jalore_Bagoda Road","ExternalAccountId":"0","LoanApplicationNumber":null,"FutureDatedAmount":"0.00","SafeDepositBoxId":"0","Iban":"0","DateAccountOpen":"2017-09-28","DateAccountActive":null,"DateRelation":"2017-09-28","MonthsSinceActive":"47","BalUncollectedPrinc":"0.00","BalUncollectedInt":"0.00","TotalBalUncollecPrinc":"0.00","TotalBalUncollecInt":"0.00","TotalBalBook":"99.00","DateValue":"2017-05-04","BalPrincipal":"0","IntRate":"0","DepositNo":null,"MaturityDate":null,"LienAmount":"0","InstallmentAmount":"0","OtherArrear":"0","DepositStatus":null,"BalCombinedAcy":"699.0","BalCombinedLcy":"699.0","BranchCode":"2276","IsMaturity":null,"IsTDLinkage":"N ","MaturityAmount":null,"DepStat":null,"DisbursedAmount":null,"DraweeAccountNo":null,"EmailId":null,"EmiTenure":null,"HoldAmount":"0","LoanAccountName":null,"MobileNumber":null,"NomineeName":"PRAVEENA BANU","ODLimitSactioned":"0","ODLimitUtilized":"0","OperationMode":"SINGLYnull","SmallClearingAccountNo":"000207","TDAccountName":null,"CASARelationshipDetails":{"CustomerId":"21314552","Emailid":"21314552@axc.com","JointHolderName":"IFRAN KHAN","MobileNo":"8104655801","Relationship":"SOW"},"AmtGoal":"0","AmtGoalNew":null,"CodAcctCcy":null,"CodAcctNo":null,"CodGoalAcctStat":null,"CodGoalAcctXfer":null,"CodGoalAcctXferTitle":null,"CodGoalName":null,"CodGoalRefNo":null,"CtrGoalTermDays":null,"CtrGoalTermDaysNew":null,"CtrGoalTermMon":null,"CtrGoalTermMonNew":null,"CtrGoalTermYear":null,"CtrGoalTermYearNew":null,"DatMaturityNew":null,"ProductCode":"20101","RatGoalInt":null,"Tenure":"0 Months 0 Days 0 Years "},{"ModuleCode":"L","ProductName":"10103-Securitization and Assignment","AccountId":"9001020101389851","CASAAccountName":null,"CurrencyCode":"1","CurrencyShortName":"INR","CustomerRelationship":"SOW","BalanceBook":"0.00","UnclearFunds":"0.00","Classification":"NORMAL","Reason":" ","BillAmount":"0.00","OriginalBalance":"390000.00","CurrentStatus":"1","CurrentStatusDescription":"ACCOUNT CLOSED","AcyAmount":"0.00","AvailableBalance":"0.00","LcyAmount":"0.00","TotalAcyAmount":"0.00","TotalLcyAmount":"0.00","BranchName":"Jalore_Bagoda Road","ExternalAccountId":null,"LoanApplicationNumber":"9001020101389851 ","FutureDatedAmount":"0.00","SafeDepositBoxId":"0","Iban":null,"DateAccountOpen":"2014-12-25","DateAccountActive":null,"DateRelation":null,"MonthsSinceActive":"0","BalUncollectedPrinc":"0.00","BalUncollectedInt":"0.00","TotalBalUncollecPrinc":"0.00","TotalBalUncollecInt":"0.00","TotalBalBook":"0.00","DateValue":null,"BalPrincipal":"0","IntRate":"0","DepositNo":null,"MaturityDate":"2017-11-23","LienAmount":"0","InstallmentAmount":"0","OtherArrear":"0","DepositStatus":null,"BalCombinedAcy":"0.0","BalCombinedLcy":"0.0","BranchCode":"2276","IsMaturity":null,"IsTDLinkage":"N ","MaturityAmount":null,"DepStat":null,"DisbursedAmount":"390000","DraweeAccountNo":null,"EmailId":null,"EmiTenure":"35","HoldAmount":null,"LoanAccountName":"IFRAN Khan","MobileNumber":null,"NomineeName":null,"ODLimitSactioned":null,"ODLimitUtilized":null,"OperationMode":null,"SmallClearingAccountNo":null,"TDAccountName":null,"AmtGoal":"0","AmtGoalNew":null,"CodAcctCcy":null,"CodAcctNo":null,"CodGoalAcctStat":null,"CodGoalAcctXfer":null,"CodGoalAcctXferTitle":null,"CodGoalName":null,"CodGoalRefNo":null,"CtrGoalTermDays":null,"CtrGoalTermDaysNew":null,"CtrGoalTermMon":null,"CtrGoalTermMonNew":null,"CtrGoalTermYear":null,"CtrGoalTermYearNew":null,"DatMaturityNew":null,"ProductCode":"10103","RatGoalInt":null,"Tenure":"35 Months 0 Days 0 Years "}]}}]}' // Mock JSON response
        );
        insert integrationChecklist;
        // Call the method under test
        Test.startTest();
        Boolean isLoanRejected = AUSF_LoanApplicationService.aditionalDedupeCheck(applicant.Id);
        Test.stopTest();

        // Verify the results
        loanApp = [SELECT Stage__c, Reject_Reason__c FROM Loan_Application__c WHERE Id = :loanApp.Id];
        System.assertEquals(true, isLoanRejected);
        System.assertEquals('Reject', loanApp.Stage__c);
        System.assertEquals('Dedupe check', loanApp.Reject_Reason__c);  // Update with actual reason code
    }
    @isTest
    static void testAditionalDedupeCheckForSelPaOffr() {
        // Create test data for Loan_Application__c
        Applicant__c applicant = [SELECT Id,Loan_Application__c,Mobile_Number__c,PAN__c,Loan_Application__r.Employment_Type_Formula__c,Loan_Application__r.Has_PA_Offer__c FROM Applicant__c WHERE Loan_Application__r.Stage__c='Pending'];
        Loan_Application__c loanApp = new Loan_Application__c(
            Id = applicant.Loan_Application__c,
            Employment_Type_Formula__c = 'Salaried',
            Has_PA_Offer__c = true
        );
        update loanApp;

        // Create test data for Applicant__c
        applicant.Mobile_Number__c ='1234567890';
        applicant.PAN__c = 'ABCDE1234F';
        update applicant;

        Integration_Master__c intMaster = AUSF_TestDataFactory.createIntegrationMaster('Customer Dedupe Detail','','','','','');
        insert intMaster;
        // Create test data for Integration_Checklist__c
        Integration_Checklist__c integrationChecklist = new Integration_Checklist__c(
            Integration_Master__c = intMaster.Id,
            Loan_Application__c = loanApp.Id,
            Applicant__c = applicant.Id,
            Status__c = 'Completed',  // AUSF_IC_COMPLETED
            Response__c = '{"TransactionStatus":{"ResponseCode":"0","ResponseMessage":"Success","ExtendedErrorDetails":{"messages":{"code":"0","message":null}},"ValidationErrors":{"ApplicableAttributes":null,"AttributeName":null,"AttributeValue":null,"ErrorCode":null,"ErrorMessage":null}},"MatchFound":[{"CustomerResponse":{"CustomerMemo":null,"CustomerBasicInquiry":{"CustomerId":"2131455278","NationalIdentificationCode":"2131455278","CustomerName":{"Prefix":"MR.","FirstName":"IFRAN","MidName":null,"LastName":"KHAN","ShortName":"IFRAN Khan","SingleFullName":null,"FormattedFullName":"IFRAN##KHAN","FullName":"IFRAN KHAN"},"CustomerFullName":"IFRAN KHAN","OfficerID":null,"CustomerAddress":{"Line1":"5th floor","Line2":"Kanakia Zillon","Line3":"BKC Kurla West","Line4":null,"City":"MUMBAI","State":"MAHARASHTRA","Country":"India","Zip":"400070"},"BirthDateText":"1984-06-07","CategoryType":"INDIVIDUAL - FULL KYC","Sex":"M","IsImageAvailable":"false","IsSignatureAvailable":"true","CombWithdrawBal":null,"AgeOfCustRel":"2017-09-28","AadhaarDetail":{"AadhaarNumber":"21314552","AadhaarLinkAccount":null},"HomeBranch":"2276","MobileNumber":"1234567890","EmailAddress":"21314552@axc.com","IcType":null,"IcTypeDesc":null,"BankShortName":"Jalore_Bagoda Road","PAN":"ABCDE1234F","CustomerType":"100","AadharUpdateDate":null}},"CRMQueryResults":[{"BankName":null,"Scheme":null,"Avail":"No","off_ex1_8":null,"ProductId":11704,"OfferType":null,"OfferId":"726882","RatingID":1,"ValidFrom":"2023-06-26T00:00:00+05:30","OfferDescription":"Savings Account - AU Royale","Royale":null,"MinLoanTenureinMonths":"6","CustomerNameinBankAccount":null,"CustomerId":"22143391","OfferIsActive":"true","RepaymentMode":null,"Mobile":"9988774410","CurrencyID":null,"MaxLoanTenureinMonths":"48","OfferName":"Savings Account - AU Royale","Occupation":null,"IFSCcode":null,"RowNumber":1,"FirstOfferAmount":300000,"Employee":null,"BankBranch":null,"ValidTill":"2025-06-27T23:59:00+05:30","Image_Offers":"plbanner","TermsAndCondition":null,"RateofInterest":"16.000000","Location":null,"TerritoryCode":"2011","loginid":null,"OfferSource":"Website Download","remarks":"PL","Comments":"1.25","BankAccountNumber":"2342346238","CIBILScore":"195"}],"CreditCardResponse":[{"CustomerID":"2233XXXX","CustomerAccountRelation":"Sole Owner","AccountNumber":"0001691XXXXXXXXXXXX","LoanStatus":"PA","CustomerFullName":"AKASH G","ProductCode":"101","Decode":"ALTURA","AccountOpenDate":"2021-01-20 00:00:00","AccountStatus":"ACCOUNT OPEN REGULAR","SanctionedAmount":"50000","DPDValue":"0","LastStatementBalance":"8,692.67"}],"NPADPD":[{"GrossAdvance":66469,"Last30DaysUpg":"","ACID":"","Filler_3":"","UCIF":"25200586","Date":"27-04-2024","NPAStatus":"Y","Filler_2":"","Filler_1":"","NPADate":null,"CustID":"","IsTWO":"N","DPD":0,"AssetClass":"STANDARD","OriginalProduct":"","TotalProvision":265.88},{"GrossAdvance":66469,"Last30DaysUpg":"","ACID":"9001010635460038","Filler_3":"","UCIF":"25200586","Date":"27-04-2024","NPAStatus":"Y","Filler_2":"","Filler_1":"","NPADate":null,"CustID":"25200586","IsTWO":"N","DPD":0,"AssetClass":"STANDARD","OriginalProduct":"A_WHEELS","TotalProvision":265.88}],"AccountDetails":{"CustomerAccount":[{"ModuleCode":"C","ProductName":"20101-AU Savings Account - Value","AccountId":"1711227610089667","CASAAccountName":null,"CurrencyCode":"1","CurrencyShortName":"INR","CustomerRelationship":"SOW","BalanceBook":"99.00","UnclearFunds":"0.00","Classification":"NORMAL","Reason":"UNBLOCKED ","BillAmount":"0.00","OriginalBalance":"0.00","CurrentStatus":"8","CurrentStatusDescription":"ACCOUNT OPEN REGULAR","AcyAmount":"699.00","AvailableBalance":"699.00","LcyAmount":"699.00","TotalAcyAmount":"699.00","TotalLcyAmount":"699.00","BranchName":"Jalore_Bagoda Road","ExternalAccountId":"0","LoanApplicationNumber":null,"FutureDatedAmount":"0.00","SafeDepositBoxId":"0","Iban":"0","DateAccountOpen":"2017-09-28","DateAccountActive":null,"DateRelation":"2017-09-28","MonthsSinceActive":"47","BalUncollectedPrinc":"0.00","BalUncollectedInt":"0.00","TotalBalUncollecPrinc":"0.00","TotalBalUncollecInt":"0.00","TotalBalBook":"99.00","DateValue":"2017-05-04","BalPrincipal":"0","IntRate":"0","DepositNo":null,"MaturityDate":null,"LienAmount":"0","InstallmentAmount":"0","OtherArrear":"0","DepositStatus":null,"BalCombinedAcy":"699.0","BalCombinedLcy":"699.0","BranchCode":"2276","IsMaturity":null,"IsTDLinkage":"N ","MaturityAmount":null,"DepStat":null,"DisbursedAmount":null,"DraweeAccountNo":null,"EmailId":null,"EmiTenure":null,"HoldAmount":"0","LoanAccountName":null,"MobileNumber":null,"NomineeName":"PRAVEENA BANU","ODLimitSactioned":"0","ODLimitUtilized":"0","OperationMode":"SINGLYnull","SmallClearingAccountNo":"000207","TDAccountName":null,"CASARelationshipDetails":{"CustomerId":"21314552","Emailid":"21314552@axc.com","JointHolderName":"IFRAN KHAN","MobileNo":"8104655801","Relationship":"SOW"},"AmtGoal":"0","AmtGoalNew":null,"CodAcctCcy":null,"CodAcctNo":null,"CodGoalAcctStat":null,"CodGoalAcctXfer":null,"CodGoalAcctXferTitle":null,"CodGoalName":null,"CodGoalRefNo":null,"CtrGoalTermDays":null,"CtrGoalTermDaysNew":null,"CtrGoalTermMon":null,"CtrGoalTermMonNew":null,"CtrGoalTermYear":null,"CtrGoalTermYearNew":null,"DatMaturityNew":null,"ProductCode":"20101","RatGoalInt":null,"Tenure":"0 Months 0 Days 0 Years "},{"ModuleCode":"L","ProductName":"10612-Securitization and Assignment","AccountId":"9001020101389851","CASAAccountName":null,"CurrencyCode":"1","CurrencyShortName":"INR","CustomerRelationship":"SOW","BalanceBook":"0.00","UnclearFunds":"0.00","Classification":"NORMAL","Reason":" ","BillAmount":"0.00","OriginalBalance":"390000.00","CurrentStatus":"8","CurrentStatusDescription":"ACCOUNT CLOSED","AcyAmount":"0.00","AvailableBalance":"0.00","LcyAmount":"0.00","TotalAcyAmount":"0.00","TotalLcyAmount":"0.00","BranchName":"Jalore_Bagoda Road","ExternalAccountId":null,"LoanApplicationNumber":"9001020101389851 ","FutureDatedAmount":"0.00","SafeDepositBoxId":"0","Iban":null,"DateAccountOpen":"2014-12-25","DateAccountActive":null,"DateRelation":null,"MonthsSinceActive":"0","BalUncollectedPrinc":"0.00","BalUncollectedInt":"0.00","TotalBalUncollecPrinc":"0.00","TotalBalUncollecInt":"0.00","TotalBalBook":"0.00","DateValue":null,"BalPrincipal":"0","IntRate":"0","DepositNo":null,"MaturityDate":"2017-11-23","LienAmount":"0","InstallmentAmount":"0","OtherArrear":"0","DepositStatus":null,"BalCombinedAcy":"0.0","BalCombinedLcy":"0.0","BranchCode":"2276","IsMaturity":null,"IsTDLinkage":"N ","MaturityAmount":null,"DepStat":null,"DisbursedAmount":"390000","DraweeAccountNo":null,"EmailId":null,"EmiTenure":"35","HoldAmount":null,"LoanAccountName":"IFRAN Khan","MobileNumber":null,"NomineeName":null,"ODLimitSactioned":null,"ODLimitUtilized":null,"OperationMode":null,"SmallClearingAccountNo":null,"TDAccountName":null,"AmtGoal":"0","AmtGoalNew":null,"CodAcctCcy":null,"CodAcctNo":null,"CodGoalAcctStat":null,"CodGoalAcctXfer":null,"CodGoalAcctXferTitle":null,"CodGoalName":null,"CodGoalRefNo":null,"CtrGoalTermDays":null,"CtrGoalTermDaysNew":null,"CtrGoalTermMon":null,"CtrGoalTermMonNew":null,"CtrGoalTermYear":null,"CtrGoalTermYearNew":null,"DatMaturityNew":null,"ProductCode":"10612","RatGoalInt":null,"Tenure":"35 Months 0 Days 0 Years "}]}},{"CustomerResponse":{"CustomerMemo":null,"CustomerBasicInquiry":{"CustomerId":"21314552","NationalIdentificationCode":"21314552","CustomerName":{"Prefix":"MR.","FirstName":"IFRAN","MidName":null,"LastName":"KHAN","ShortName":"IFRAN Khan","SingleFullName":null,"FormattedFullName":"IFRAN##KHAN","FullName":"IFRAN KHAN"},"CustomerFullName":"IFRAN KHAN","OfficerID":null,"CustomerAddress":{"Line1":"5th floor","Line2":"Kanakia Zillon","Line3":"BKC Kurla West","Line4":null,"City":"MUMBAI","State":"MAHARASHTRA","Country":"India","Zip":"400070"},"BirthDateText":"1984-06-07","CategoryType":"INDIVIDUAL - FULL KYC","Sex":"M","IsImageAvailable":"false","IsSignatureAvailable":"true","CombWithdrawBal":null,"AgeOfCustRel":"2017-09-28","AadhaarDetail":{"AadhaarNumber":"21314552","AadhaarLinkAccount":null},"HomeBranch":"2276","MobileNumber":"8104655801","EmailAddress":"21314552@axc.com","IcType":null,"IcTypeDesc":null,"BankShortName":"Jalore_Bagoda Road","PAN":"ABCDE3333R","CustomerType":"100","AadharUpdateDate":null}},"CRMQueryResults":[{"BankName":null,"Scheme":null,"Avail":"No","off_ex1_8":null,"ProductId":11704,"OfferType":null,"OfferId":"726882","RatingID":1,"ValidFrom":"2023-06-26T00:00:00+05:30","OfferDescription":"Savings Account - AU Royale","Royale":null,"MinLoanTenureinMonths":"6","CustomerNameinBankAccount":null,"CustomerId":"22143391","OfferIsActive":"true","RepaymentMode":null,"Mobile":"9988774410","CurrencyID":null,"MaxLoanTenureinMonths":"48","OfferName":"Savings Account - AU Royale","Occupation":null,"IFSCcode":null,"RowNumber":1,"FirstOfferAmount":300000,"Employee":null,"BankBranch":null,"ValidTill":"2025-06-27T23:59:00+05:30","Image_Offers":"plbanner","TermsAndCondition":null,"RateofInterest":"16.000000","Location":null,"TerritoryCode":"2011","loginid":null,"OfferSource":"Website Download","remarks":"PL","Comments":"1.25","BankAccountNumber":"23423462387","CIBILScore":"195"}],"CreditCardResponse":[{"CustomerID":"2233XXXX","CustomerAccountRelation":"Sole Owner","AccountNumber":"0001691XXXXXXXXXXXX","LoanStatus":"PA","CustomerFullName":"AKASH G","ProductCode":"101","Decode":"ALTURA","AccountOpenDate":"2021-01-20 00:00:00","AccountStatus":"ACCOUNT OPEN REGULAR","SanctionedAmount":"50000","DPDValue":"0","LastStatementBalance":"8,692.67"}],"NPADPD":[{"GrossAdvance":66469,"Last30DaysUpg":"","ACID":"","Filler_3":"","UCIF":"25200586","Date":"27-04-2024","NPAStatus":"N","Filler_2":"","Filler_1":"","NPADate":null,"CustID":"","IsTWO":"N","DPD":0,"AssetClass":"STANDARD","OriginalProduct":"","TotalProvision":265.88},{"GrossAdvance":66469,"Last30DaysUpg":"","ACID":"9001010635460038","Filler_3":"","UCIF":"25200586","Date":"27-04-2024","NPAStatus":"N","Filler_2":"","Filler_1":"","NPADate":null,"CustID":"25200586","IsTWO":"N","DPD":0,"AssetClass":"STANDARD","OriginalProduct":"A_WHEELS","TotalProvision":265.88}],"AccountDetails":{"CustomerAccount":[{"ModuleCode":"C","ProductName":"20101-AU Savings Account - Value","AccountId":"1711227610089667","CASAAccountName":null,"CurrencyCode":"1","CurrencyShortName":"INR","CustomerRelationship":"SOW","BalanceBook":"99.00","UnclearFunds":"0.00","Classification":"NORMAL","Reason":"UNBLOCKED ","BillAmount":"0.00","OriginalBalance":"0.00","CurrentStatus":"8","CurrentStatusDescription":"ACCOUNT OPEN REGULAR","AcyAmount":"699.00","AvailableBalance":"699.00","LcyAmount":"699.00","TotalAcyAmount":"699.00","TotalLcyAmount":"699.00","BranchName":"Jalore_Bagoda Road","ExternalAccountId":"0","LoanApplicationNumber":null,"FutureDatedAmount":"0.00","SafeDepositBoxId":"0","Iban":"0","DateAccountOpen":"2017-09-28","DateAccountActive":null,"DateRelation":"2017-09-28","MonthsSinceActive":"47","BalUncollectedPrinc":"0.00","BalUncollectedInt":"0.00","TotalBalUncollecPrinc":"0.00","TotalBalUncollecInt":"0.00","TotalBalBook":"99.00","DateValue":"2017-05-04","BalPrincipal":"0","IntRate":"0","DepositNo":null,"MaturityDate":null,"LienAmount":"0","InstallmentAmount":"0","OtherArrear":"0","DepositStatus":null,"BalCombinedAcy":"699.0","BalCombinedLcy":"699.0","BranchCode":"2276","IsMaturity":null,"IsTDLinkage":"N ","MaturityAmount":null,"DepStat":null,"DisbursedAmount":null,"DraweeAccountNo":null,"EmailId":null,"EmiTenure":null,"HoldAmount":"0","LoanAccountName":null,"MobileNumber":null,"NomineeName":"PRAVEENA BANU","ODLimitSactioned":"0","ODLimitUtilized":"0","OperationMode":"SINGLYnull","SmallClearingAccountNo":"000207","TDAccountName":null,"CASARelationshipDetails":{"CustomerId":"21314552","Emailid":"21314552@axc.com","JointHolderName":"IFRAN KHAN","MobileNo":"8104655801","Relationship":"SOW"},"AmtGoal":"0","AmtGoalNew":null,"CodAcctCcy":null,"CodAcctNo":null,"CodGoalAcctStat":null,"CodGoalAcctXfer":null,"CodGoalAcctXferTitle":null,"CodGoalName":null,"CodGoalRefNo":null,"CtrGoalTermDays":null,"CtrGoalTermDaysNew":null,"CtrGoalTermMon":null,"CtrGoalTermMonNew":null,"CtrGoalTermYear":null,"CtrGoalTermYearNew":null,"DatMaturityNew":null,"ProductCode":"20101","RatGoalInt":null,"Tenure":"0 Months 0 Days 0 Years "},{"ModuleCode":"L","ProductName":"10612-Securitization and Assignment","AccountId":"9001020101389851","CASAAccountName":null,"CurrencyCode":"1","CurrencyShortName":"INR","CustomerRelationship":"SOW","BalanceBook":"0.00","UnclearFunds":"0.00","Classification":"NORMAL","Reason":" ","BillAmount":"0.00","OriginalBalance":"390000.00","CurrentStatus":"1","CurrentStatusDescription":"ACCOUNT CLOSED","AcyAmount":"0.00","AvailableBalance":"0.00","LcyAmount":"0.00","TotalAcyAmount":"0.00","TotalLcyAmount":"0.00","BranchName":"Jalore_Bagoda Road","ExternalAccountId":null,"LoanApplicationNumber":"9001020101389851 ","FutureDatedAmount":"0.00","SafeDepositBoxId":"0","Iban":null,"DateAccountOpen":"2014-12-25","DateAccountActive":null,"DateRelation":null,"MonthsSinceActive":"0","BalUncollectedPrinc":"0.00","BalUncollectedInt":"0.00","TotalBalUncollecPrinc":"0.00","TotalBalUncollecInt":"0.00","TotalBalBook":"0.00","DateValue":null,"BalPrincipal":"0","IntRate":"0","DepositNo":null,"MaturityDate":"2017-11-23","LienAmount":"0","InstallmentAmount":"0","OtherArrear":"0","DepositStatus":null,"BalCombinedAcy":"0.0","BalCombinedLcy":"0.0","BranchCode":"2276","IsMaturity":null,"IsTDLinkage":"N ","MaturityAmount":null,"DepStat":null,"DisbursedAmount":"390000","DraweeAccountNo":null,"EmailId":null,"EmiTenure":"35","HoldAmount":null,"LoanAccountName":"IFRAN Khan","MobileNumber":null,"NomineeName":null,"ODLimitSactioned":null,"ODLimitUtilized":null,"OperationMode":null,"SmallClearingAccountNo":null,"TDAccountName":null,"AmtGoal":"0","AmtGoalNew":null,"CodAcctCcy":null,"CodAcctNo":null,"CodGoalAcctStat":null,"CodGoalAcctXfer":null,"CodGoalAcctXferTitle":null,"CodGoalName":null,"CodGoalRefNo":null,"CtrGoalTermDays":null,"CtrGoalTermDaysNew":null,"CtrGoalTermMon":null,"CtrGoalTermMonNew":null,"CtrGoalTermYear":null,"CtrGoalTermYearNew":null,"DatMaturityNew":null,"ProductCode":"10612","RatGoalInt":null,"Tenure":"35 Months 0 Days 0 Years "}]}}]}' // Mock JSON response
        );
        insert integrationChecklist;
        // Call the method under test
        Test.startTest();
        Boolean isLoanRejected = AUSF_LoanApplicationService.aditionalDedupeCheck(applicant.Id);
        Test.stopTest();

        // Verify the results
        loanApp = [SELECT Stage__c, Reject_Reason__c FROM Loan_Application__c WHERE Id = :loanApp.Id];
        System.assertEquals(true, isLoanRejected);
        System.assertEquals('Reject', loanApp.Stage__c);
        System.assertEquals('Dedupe check', loanApp.Reject_Reason__c);  // Update with actual reason code
    }
    @isTest
    static void testAditionalDedupeCheckForSelNonPaOffr() {
        // Create test data for Loan_Application__c
        Applicant__c applicant = [SELECT Id,Loan_Application__c,Mobile_Number__c,PAN__c,Loan_Application__r.Employment_Type_Formula__c,Loan_Application__r.Has_PA_Offer__c FROM Applicant__c WHERE Loan_Application__r.Stage__c='Pending'];
        Loan_Application__c loanApp = new Loan_Application__c(
            Id = applicant.Loan_Application__c,
            Employment_Type_Formula__c = 'Salaried',
            Has_PA_Offer__c = false
        );
        update loanApp;

        // Create test data for Applicant__c
        applicant.Mobile_Number__c ='1234567890';
        applicant.PAN__c = 'ABCDE1234F';
        update applicant;

        Integration_Master__c intMaster = AUSF_TestDataFactory.createIntegrationMaster('Customer Dedupe Detail','','','','','');
        insert intMaster;
        // Create test data for Integration_Checklist__c
        Integration_Checklist__c integrationChecklist = new Integration_Checklist__c(
            Integration_Master__c = intMaster.Id,
            Loan_Application__c = loanApp.Id,
            Applicant__c = applicant.Id,
            Status__c = 'Completed',  // AUSF_IC_COMPLETED
            Response__c = '{"TransactionStatus":{"ResponseCode":"0","ResponseMessage":"Success","ExtendedErrorDetails":{"messages":{"code":"0","message":null}},"ValidationErrors":{"ApplicableAttributes":null,"AttributeName":null,"AttributeValue":null,"ErrorCode":null,"ErrorMessage":null}},"MatchFound":[{"CustomerResponse":{"CustomerMemo":null,"CustomerBasicInquiry":{"CustomerId":"2131455278","NationalIdentificationCode":"2131455278","CustomerName":{"Prefix":"MR.","FirstName":"IFRAN","MidName":null,"LastName":"KHAN","ShortName":"IFRAN Khan","SingleFullName":null,"FormattedFullName":"IFRAN##KHAN","FullName":"IFRAN KHAN"},"CustomerFullName":"IFRAN KHAN","OfficerID":null,"CustomerAddress":{"Line1":"5th floor","Line2":"Kanakia Zillon","Line3":"BKC Kurla West","Line4":null,"City":"MUMBAI","State":"MAHARASHTRA","Country":"India","Zip":"400070"},"BirthDateText":"1984-06-07","CategoryType":"INDIVIDUAL - FULL KYC","Sex":"M","IsImageAvailable":"false","IsSignatureAvailable":"true","CombWithdrawBal":null,"AgeOfCustRel":"2017-09-28","AadhaarDetail":{"AadhaarNumber":"21314552","AadhaarLinkAccount":null},"HomeBranch":"2276","MobileNumber":"1234567890","EmailAddress":"21314552@axc.com","IcType":null,"IcTypeDesc":null,"BankShortName":"Jalore_Bagoda Road","PAN":"ABCDE1234F","CustomerType":"100","AadharUpdateDate":null}},"CRMQueryResults":[{"BankName":null,"Scheme":null,"Avail":"No","off_ex1_8":null,"ProductId":11704,"OfferType":null,"OfferId":"726882","RatingID":1,"ValidFrom":"2023-06-26T00:00:00+05:30","OfferDescription":"Savings Account - AU Royale","Royale":null,"MinLoanTenureinMonths":"6","CustomerNameinBankAccount":null,"CustomerId":"22143391","OfferIsActive":"true","RepaymentMode":null,"Mobile":"9988774410","CurrencyID":null,"MaxLoanTenureinMonths":"48","OfferName":"Savings Account - AU Royale","Occupation":null,"IFSCcode":null,"RowNumber":1,"FirstOfferAmount":300000,"Employee":null,"BankBranch":null,"ValidTill":"2025-06-27T23:59:00+05:30","Image_Offers":"plbanner","TermsAndCondition":null,"RateofInterest":"16.000000","Location":null,"TerritoryCode":"2011","loginid":null,"OfferSource":"Website Download","remarks":"PL","Comments":"1.25","BankAccountNumber":"2342346238","CIBILScore":"195"}],"CreditCardResponse":[{"CustomerID":"2233XXXX","CustomerAccountRelation":"Sole Owner","AccountNumber":"0001691XXXXXXXXXXXX","LoanStatus":"PA","CustomerFullName":"AKASH G","ProductCode":"101","Decode":"ALTURA","AccountOpenDate":"2021-01-20 00:00:00","AccountStatus":"ACCOUNT OPEN REGULAR","SanctionedAmount":"50000","DPDValue":"0","LastStatementBalance":"8,692.67"}],"NPADPD":[{"GrossAdvance":66469,"Last30DaysUpg":"","ACID":"","Filler_3":"","UCIF":"25200586","Date":"27-04-2024","NPAStatus":"Y","Filler_2":"","Filler_1":"","NPADate":null,"CustID":"","IsTWO":"N","DPD":0,"AssetClass":"STANDARD","OriginalProduct":"","TotalProvision":265.88},{"GrossAdvance":66469,"Last30DaysUpg":"","ACID":"9001010635460038","Filler_3":"","UCIF":"25200586","Date":"27-04-2024","NPAStatus":"Y","Filler_2":"","Filler_1":"","NPADate":null,"CustID":"25200586","IsTWO":"N","DPD":0,"AssetClass":"STANDARD","OriginalProduct":"A_WHEELS","TotalProvision":265.88}],"AccountDetails":{"CustomerAccount":[{"ModuleCode":"C","ProductName":"20101-AU Savings Account - Value","AccountId":"1711227610089667","CASAAccountName":null,"CurrencyCode":"1","CurrencyShortName":"INR","CustomerRelationship":"SOW","BalanceBook":"99.00","UnclearFunds":"0.00","Classification":"NORMAL","Reason":"UNBLOCKED ","BillAmount":"0.00","OriginalBalance":"0.00","CurrentStatus":"8","CurrentStatusDescription":"ACCOUNT OPEN REGULAR","AcyAmount":"699.00","AvailableBalance":"699.00","LcyAmount":"699.00","TotalAcyAmount":"699.00","TotalLcyAmount":"699.00","BranchName":"Jalore_Bagoda Road","ExternalAccountId":"0","LoanApplicationNumber":null,"FutureDatedAmount":"0.00","SafeDepositBoxId":"0","Iban":"0","DateAccountOpen":"2017-09-28","DateAccountActive":null,"DateRelation":"2017-09-28","MonthsSinceActive":"47","BalUncollectedPrinc":"0.00","BalUncollectedInt":"0.00","TotalBalUncollecPrinc":"0.00","TotalBalUncollecInt":"0.00","TotalBalBook":"99.00","DateValue":"2017-05-04","BalPrincipal":"0","IntRate":"0","DepositNo":null,"MaturityDate":null,"LienAmount":"0","InstallmentAmount":"0","OtherArrear":"0","DepositStatus":null,"BalCombinedAcy":"699.0","BalCombinedLcy":"699.0","BranchCode":"2276","IsMaturity":null,"IsTDLinkage":"N ","MaturityAmount":null,"DepStat":null,"DisbursedAmount":null,"DraweeAccountNo":null,"EmailId":null,"EmiTenure":null,"HoldAmount":"0","LoanAccountName":null,"MobileNumber":null,"NomineeName":"PRAVEENA BANU","ODLimitSactioned":"0","ODLimitUtilized":"0","OperationMode":"SINGLYnull","SmallClearingAccountNo":"000207","TDAccountName":null,"CASARelationshipDetails":{"CustomerId":"21314552","Emailid":"21314552@axc.com","JointHolderName":"IFRAN KHAN","MobileNo":"8104655801","Relationship":"SOW"},"AmtGoal":"0","AmtGoalNew":null,"CodAcctCcy":null,"CodAcctNo":null,"CodGoalAcctStat":null,"CodGoalAcctXfer":null,"CodGoalAcctXferTitle":null,"CodGoalName":null,"CodGoalRefNo":null,"CtrGoalTermDays":null,"CtrGoalTermDaysNew":null,"CtrGoalTermMon":null,"CtrGoalTermMonNew":null,"CtrGoalTermYear":null,"CtrGoalTermYearNew":null,"DatMaturityNew":null,"ProductCode":"20101","RatGoalInt":null,"Tenure":"0 Months 0 Days 0 Years "},{"ModuleCode":"L","ProductName":"10612-Securitization and Assignment","AccountId":"9001020101389851","CASAAccountName":null,"CurrencyCode":"1","CurrencyShortName":"INR","CustomerRelationship":"SOW","BalanceBook":"0.00","UnclearFunds":"0.00","Classification":"NORMAL","Reason":" ","BillAmount":"0.00","OriginalBalance":"390000.00","CurrentStatus":"8","CurrentStatusDescription":"ACCOUNT CLOSED","AcyAmount":"0.00","AvailableBalance":"0.00","LcyAmount":"0.00","TotalAcyAmount":"0.00","TotalLcyAmount":"0.00","BranchName":"Jalore_Bagoda Road","ExternalAccountId":null,"LoanApplicationNumber":"9001020101389851 ","FutureDatedAmount":"0.00","SafeDepositBoxId":"0","Iban":null,"DateAccountOpen":"2014-12-25","DateAccountActive":null,"DateRelation":null,"MonthsSinceActive":"0","BalUncollectedPrinc":"0.00","BalUncollectedInt":"0.00","TotalBalUncollecPrinc":"0.00","TotalBalUncollecInt":"0.00","TotalBalBook":"0.00","DateValue":null,"BalPrincipal":"0","IntRate":"0","DepositNo":null,"MaturityDate":"2017-11-23","LienAmount":"0","InstallmentAmount":"0","OtherArrear":"0","DepositStatus":null,"BalCombinedAcy":"0.0","BalCombinedLcy":"0.0","BranchCode":"2276","IsMaturity":null,"IsTDLinkage":"N ","MaturityAmount":null,"DepStat":null,"DisbursedAmount":"390000","DraweeAccountNo":null,"EmailId":null,"EmiTenure":"35","HoldAmount":null,"LoanAccountName":"IFRAN Khan","MobileNumber":null,"NomineeName":null,"ODLimitSactioned":null,"ODLimitUtilized":null,"OperationMode":null,"SmallClearingAccountNo":null,"TDAccountName":null,"AmtGoal":"0","AmtGoalNew":null,"CodAcctCcy":null,"CodAcctNo":null,"CodGoalAcctStat":null,"CodGoalAcctXfer":null,"CodGoalAcctXferTitle":null,"CodGoalName":null,"CodGoalRefNo":null,"CtrGoalTermDays":null,"CtrGoalTermDaysNew":null,"CtrGoalTermMon":null,"CtrGoalTermMonNew":null,"CtrGoalTermYear":null,"CtrGoalTermYearNew":null,"DatMaturityNew":null,"ProductCode":"10612","RatGoalInt":null,"Tenure":"35 Months 0 Days 0 Years "}]}},{"CustomerResponse":{"CustomerMemo":null,"CustomerBasicInquiry":{"CustomerId":"21314552","NationalIdentificationCode":"21314552","CustomerName":{"Prefix":"MR.","FirstName":"IFRAN","MidName":null,"LastName":"KHAN","ShortName":"IFRAN Khan","SingleFullName":null,"FormattedFullName":"IFRAN##KHAN","FullName":"IFRAN KHAN"},"CustomerFullName":"IFRAN KHAN","OfficerID":null,"CustomerAddress":{"Line1":"5th floor","Line2":"Kanakia Zillon","Line3":"BKC Kurla West","Line4":null,"City":"MUMBAI","State":"MAHARASHTRA","Country":"India","Zip":"400070"},"BirthDateText":"1984-06-07","CategoryType":"INDIVIDUAL - FULL KYC","Sex":"M","IsImageAvailable":"false","IsSignatureAvailable":"true","CombWithdrawBal":null,"AgeOfCustRel":"2017-09-28","AadhaarDetail":{"AadhaarNumber":"21314552","AadhaarLinkAccount":null},"HomeBranch":"2276","MobileNumber":"8104655801","EmailAddress":"21314552@axc.com","IcType":null,"IcTypeDesc":null,"BankShortName":"Jalore_Bagoda Road","PAN":"ABCDE3333R","CustomerType":"100","AadharUpdateDate":null}},"CRMQueryResults":[{"BankName":null,"Scheme":null,"Avail":"No","off_ex1_8":null,"ProductId":11704,"OfferType":null,"OfferId":"726882","RatingID":1,"ValidFrom":"2023-06-26T00:00:00+05:30","OfferDescription":"Savings Account - AU Royale","Royale":null,"MinLoanTenureinMonths":"6","CustomerNameinBankAccount":null,"CustomerId":"22143391","OfferIsActive":"true","RepaymentMode":null,"Mobile":"9988774410","CurrencyID":null,"MaxLoanTenureinMonths":"48","OfferName":"Savings Account - AU Royale","Occupation":null,"IFSCcode":null,"RowNumber":1,"FirstOfferAmount":300000,"Employee":null,"BankBranch":null,"ValidTill":"2025-06-27T23:59:00+05:30","Image_Offers":"plbanner","TermsAndCondition":null,"RateofInterest":"16.000000","Location":null,"TerritoryCode":"2011","loginid":null,"OfferSource":"Website Download","remarks":"PL","Comments":"1.25","BankAccountNumber":"23423462387","CIBILScore":"195"}],"CreditCardResponse":[{"CustomerID":"2233XXXX","CustomerAccountRelation":"Sole Owner","AccountNumber":"0001691XXXXXXXXXXXX","LoanStatus":"PA","CustomerFullName":"AKASH G","ProductCode":"101","Decode":"ALTURA","AccountOpenDate":"2021-01-20 00:00:00","AccountStatus":"ACCOUNT OPEN REGULAR","SanctionedAmount":"50000","DPDValue":"0","LastStatementBalance":"8,692.67"}],"NPADPD":[{"GrossAdvance":66469,"Last30DaysUpg":"","ACID":"","Filler_3":"","UCIF":"25200586","Date":"27-04-2024","NPAStatus":"N","Filler_2":"","Filler_1":"","NPADate":null,"CustID":"","IsTWO":"N","DPD":0,"AssetClass":"STANDARD","OriginalProduct":"","TotalProvision":265.88},{"GrossAdvance":66469,"Last30DaysUpg":"","ACID":"9001010635460038","Filler_3":"","UCIF":"25200586","Date":"27-04-2024","NPAStatus":"N","Filler_2":"","Filler_1":"","NPADate":null,"CustID":"25200586","IsTWO":"N","DPD":0,"AssetClass":"STANDARD","OriginalProduct":"A_WHEELS","TotalProvision":265.88}],"AccountDetails":{"CustomerAccount":[{"ModuleCode":"C","ProductName":"20101-AU Savings Account - Value","AccountId":"1711227610089667","CASAAccountName":null,"CurrencyCode":"1","CurrencyShortName":"INR","CustomerRelationship":"SOW","BalanceBook":"99.00","UnclearFunds":"0.00","Classification":"NORMAL","Reason":"UNBLOCKED ","BillAmount":"0.00","OriginalBalance":"0.00","CurrentStatus":"8","CurrentStatusDescription":"ACCOUNT OPEN REGULAR","AcyAmount":"699.00","AvailableBalance":"699.00","LcyAmount":"699.00","TotalAcyAmount":"699.00","TotalLcyAmount":"699.00","BranchName":"Jalore_Bagoda Road","ExternalAccountId":"0","LoanApplicationNumber":null,"FutureDatedAmount":"0.00","SafeDepositBoxId":"0","Iban":"0","DateAccountOpen":"2017-09-28","DateAccountActive":null,"DateRelation":"2017-09-28","MonthsSinceActive":"47","BalUncollectedPrinc":"0.00","BalUncollectedInt":"0.00","TotalBalUncollecPrinc":"0.00","TotalBalUncollecInt":"0.00","TotalBalBook":"99.00","DateValue":"2017-05-04","BalPrincipal":"0","IntRate":"0","DepositNo":null,"MaturityDate":null,"LienAmount":"0","InstallmentAmount":"0","OtherArrear":"0","DepositStatus":null,"BalCombinedAcy":"699.0","BalCombinedLcy":"699.0","BranchCode":"2276","IsMaturity":null,"IsTDLinkage":"N ","MaturityAmount":null,"DepStat":null,"DisbursedAmount":null,"DraweeAccountNo":null,"EmailId":null,"EmiTenure":null,"HoldAmount":"0","LoanAccountName":null,"MobileNumber":null,"NomineeName":"PRAVEENA BANU","ODLimitSactioned":"0","ODLimitUtilized":"0","OperationMode":"SINGLYnull","SmallClearingAccountNo":"000207","TDAccountName":null,"CASARelationshipDetails":{"CustomerId":"21314552","Emailid":"21314552@axc.com","JointHolderName":"IFRAN KHAN","MobileNo":"8104655801","Relationship":"SOW"},"AmtGoal":"0","AmtGoalNew":null,"CodAcctCcy":null,"CodAcctNo":null,"CodGoalAcctStat":null,"CodGoalAcctXfer":null,"CodGoalAcctXferTitle":null,"CodGoalName":null,"CodGoalRefNo":null,"CtrGoalTermDays":null,"CtrGoalTermDaysNew":null,"CtrGoalTermMon":null,"CtrGoalTermMonNew":null,"CtrGoalTermYear":null,"CtrGoalTermYearNew":null,"DatMaturityNew":null,"ProductCode":"20101","RatGoalInt":null,"Tenure":"0 Months 0 Days 0 Years "},{"ModuleCode":"L","ProductName":"10612-Securitization and Assignment","AccountId":"9001020101389851","CASAAccountName":null,"CurrencyCode":"1","CurrencyShortName":"INR","CustomerRelationship":"SOW","BalanceBook":"0.00","UnclearFunds":"0.00","Classification":"NORMAL","Reason":" ","BillAmount":"0.00","OriginalBalance":"390000.00","CurrentStatus":"1","CurrentStatusDescription":"ACCOUNT CLOSED","AcyAmount":"0.00","AvailableBalance":"0.00","LcyAmount":"0.00","TotalAcyAmount":"0.00","TotalLcyAmount":"0.00","BranchName":"Jalore_Bagoda Road","ExternalAccountId":null,"LoanApplicationNumber":"9001020101389851 ","FutureDatedAmount":"0.00","SafeDepositBoxId":"0","Iban":null,"DateAccountOpen":"2014-12-25","DateAccountActive":null,"DateRelation":null,"MonthsSinceActive":"0","BalUncollectedPrinc":"0.00","BalUncollectedInt":"0.00","TotalBalUncollecPrinc":"0.00","TotalBalUncollecInt":"0.00","TotalBalBook":"0.00","DateValue":null,"BalPrincipal":"0","IntRate":"0","DepositNo":null,"MaturityDate":"2017-11-23","LienAmount":"0","InstallmentAmount":"0","OtherArrear":"0","DepositStatus":null,"BalCombinedAcy":"0.0","BalCombinedLcy":"0.0","BranchCode":"2276","IsMaturity":null,"IsTDLinkage":"N ","MaturityAmount":null,"DepStat":null,"DisbursedAmount":"390000","DraweeAccountNo":null,"EmailId":null,"EmiTenure":"35","HoldAmount":null,"LoanAccountName":"IFRAN Khan","MobileNumber":null,"NomineeName":null,"ODLimitSactioned":null,"ODLimitUtilized":null,"OperationMode":null,"SmallClearingAccountNo":null,"TDAccountName":null,"AmtGoal":"0","AmtGoalNew":null,"CodAcctCcy":null,"CodAcctNo":null,"CodGoalAcctStat":null,"CodGoalAcctXfer":null,"CodGoalAcctXferTitle":null,"CodGoalName":null,"CodGoalRefNo":null,"CtrGoalTermDays":null,"CtrGoalTermDaysNew":null,"CtrGoalTermMon":null,"CtrGoalTermMonNew":null,"CtrGoalTermYear":null,"CtrGoalTermYearNew":null,"DatMaturityNew":null,"ProductCode":"10612","RatGoalInt":null,"Tenure":"35 Months 0 Days 0 Years "}]}}]}' // Mock JSON response
        );
        insert integrationChecklist;
        // Call the method under test
        Test.startTest();
        Boolean isLoanRejected = AUSF_LoanApplicationService.aditionalDedupeCheck(applicant.Id);
        Test.stopTest();

        // Verify the results
        loanApp = [SELECT Stage__c, Reject_Reason__c FROM Loan_Application__c WHERE Id = :loanApp.Id];
        System.assertEquals(true, isLoanRejected);
        System.assertEquals('Reject', loanApp.Stage__c);
        System.assertEquals('Dedupe check', loanApp.Reject_Reason__c);  // Update with actual reason code
    }
    @isTest
    static void testCheckSelfEmploymentTypeSEP() {
        // Create test data
        List<Loan_Application__c> loanApplications = [SELECT Id FROM Loan_Application__c Where Stage__c='Operations' Limit 2];
        AUSF_TestDataFactory.createApplicantRecordsWithSEP(loanApplications,1);
        Applicant__c applicantSEP = [SELECT id FROM Applicant__c WHERE Employment_Type__c = 'Self Employed Professional'];
        // Test for Self Employed Professional
        String resultSEP = AUSF_LoanApplicationService.checkSelfEmploymentType(applicantSEP.Id);
        System.assertEquals('SEP', resultSEP, 'Expected SEP for Self Employed Professional');
    }
    @isTest
    static void testCheckSelfEmploymentTypeSENP() {
        // Create test data
        List<Loan_Application__c> loanApplications = [SELECT Id FROM Loan_Application__c Where Stage__c='Operations' Limit 2];
        AUSF_TestDataFactory.createApplicantRecordsWithSENP(loanApplications,1);
        Applicant__c applicantSENP = [SELECT id FROM Applicant__c WHERE Employment_Type__c = 'Self Employed Non-Professional'];
        // Test for Self Employed Non-Professional
        String resultSENP = AUSF_LoanApplicationService.checkSelfEmploymentType(applicantSENP.Id);
        System.assertEquals('SENP', resultSENP, 'Expected SENP for Self Employed Non-Professional');
    }
}